<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/style.css" rel="stylesheet" type="text/css" />
		<link href="../../css/tx/css/style.css" rel="stylesheet" type="text/css">
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init()
		</script>
	</head>
	<body>
		<div class="mui-content">
			<div class="gr_top" style="height:100px;">
			    <img src="../../img/1.png" style="margin-top: auto;"/>
			    <p><b>用户名</b></p>
			</div>
			<form enctype="multipart/form-data" id="upload_img">
				<div class="gr_con">
					<ul>
				        <li id="liFirst"><a href="javascript:void(0);" style="color:#333;">文章管理</a></li>
				        <li id="liSecond"><a href="javascript:void(0)" style="color:#333;">关于我</a></li>
				        <li id="liThird" class="hit">联系我</li>
				    </ul>
				    <div class="panes">
				        <div class="pane" style="display:block;margin-bottom:0;">
				            <div class="gr_js">
				                <p class="gr_p">
			                    		联系电话
				                    <span>
				                    	<input class="glist_right" style="line-height:30px;border: 0 none;color: #666666;text-align: left;width:100%;" name="phone" id="phone" value="0000" type="text">
				                    </span>
				                </p>
				            </div>
				            <div class="gr_js">
				                <p class="gr_p">微信二维码</p>
				                <div class="weiera" style="margin:0;" id="logoBox">
				                	<img src="../../img/gr_1.gif" id="bgl" style="width:60px; height:60px;" />
				                </div>
				                <input type="hidden" name="erweima" id="erweima" value="">
				            </div>
				        </div>
				    </div>
				</div>
				<div class="wz_foot" style="position:fixed;bottom:0;">
				    <ul>
				        <li class="wz_fleft"><a href="javascript:void(0);" id="aFirst">取消</a></li>
				        <li class="wz_fright"><a href="javascript:void(0);" id="aSave">保存</a></li>
				    </ul>
				</div>
			</form>
			<div class="htmleaf-container">
			    <div id="clipArea"></div>
			    <div id="view"></div>
			</div>
			<div id="dpage">
			    <a href="javascript:void(0);">
			        <input type="button" name="quxiao" id="quxiao" class="button" value="取消">
			    </a>
			    <a href="javascript:void(0);">
			        <input type="button" name="file" class="button" value="选取照片">
			        <input id="file" type="file" onchange="javascript:setImagePreview();" accept="image/*" multiple />
			    </a>
			    <a href="javascript:void(0);" class="qx"><button id="clipBtn">截取图片</button></a>
			</div>
		</div>
		<script src="../../js/constant.js" type="text/javascript"></script>
		<script src="../../css/tx/js/jquery.min.js" type="text/javascript"></script>
		<script>window.jQuery || document.write('<script src="../../css/tx/js/jquery-2.1.1.min.js"><\/script>')</script>
		<script src="../../css/tx/js/iscroll-zoom.js"></script>
		<script src="../../css/tx/js/hammer.js"></script>
		<script src="../../css/tx/js/jquery.photoClip.js?123"></script>
		<script>
		    var obUrl = ''
		    $("#clipArea").photoClip({
		        width: 280,
		        height: 280,
		        file: "#file",
		        view: "#view",
		        ok: "#clipBtn",
		        loadStart: function() {
//		            console.log("照片读取中");
		        },
		        loadComplete: function() {
//		            console.log("照片读取完成");
		        },
		        clipFinish: function(dataURL) {
//		            console.log(dataURL);
		        }
		    });
		</script>
		<script>
		    $(function(){
		        $("#logoBox,#s_dpage").click(function(){
		            $(".htmleaf-container").fadeIn(300);
		            $("#dpage").addClass("show");
		        })
		        $("#quxiao").click(function(){
		            $(".htmleaf-container").hide();
		            $("#dpage").removeClass("show");
		        })
		        $("#clipBtn").click(function(){
		            $("#logoBox").empty();
		            $('#logoBox').append('<img src="' + imgsource + '" align="absmiddle" style=" width:100%;margin-top:0;">');
		            $('#erweima').val(imgsource);
		            $(".htmleaf-container").hide();
		            $("#dpage").removeClass("show");
		        })
		    });
		</script>
		<script type="text/javascript">
		    function setImagePreview() {
		        var preview, img_txt, localImag, 
		        	file_head = document.getElementById("file_head"),
		            picture = file_head.value;
		        if (!picture.match(/.jpg|.gif|.png|.jpeg|.bmp/i)) return alert("您上传的图片格式不正确，请重新选择！"),
		            !1;
		        if (preview = document.getElementById("preview"), file_head.files && file_head.files[0]) preview.style.display = "block",
		            preview.style.width = "100px",
		            preview.style.height = "100px",
		            preview.src = window.navigator.userAgent.indexOf("Chrome") >= 1 || window.navigator.userAgent.indexOf("Safari") >= 1 ? window.webkitURL.createObjectURL(file_head.files[0]) : window.URL.createObjectURL(file_head.files[0]);
		        else {
		            	file_head.select(),
		                file_head.blur(),
		                img_txt = document.selection.createRange().text,
		                localImag = document.getElementById("localImag"),
		                localImag.style.width = "100px",
		                localImag.style.height = "100px";
		            try {
		                localImag.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)",
		                    localImag.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = img_txt
		            } catch(f) {
		                return alert("您上传的图片格式不正确，请重新选择！");
		            }
		            preview.style.display = "none",
		                document.selection.empty()
		        }
		        return document.getElementById("DivUp").style.display = "block";
		    }
		</script>
		<script type="text/javascript">
			function initLoad() {
				mui.ajax(REQUEST_DOMAIN + 'center/personalCenter.php/contact', {
					data: {
						token: localStorage.getItem(TOKEN)
					},
					beforeSend: function() {
				        plus.nativeUI.showWaiting('保存中...',{background:'#8f8f94',back:'none',loading:{display:'inline'}});
				    },
				    complete: function() {
				        plus.nativeUI.closeWaiting();
				    },
					dataType:'json',
					type:'POST',
					timeout:5000,
					success: renderInit,
					error: function(xhr,type,errorThrown) {
						if (type == 'timeout') {//超时
							plus.nativeUI.toast('服务器超时，请稍后重试！');
						} else {
							plus.nativeUI.toast('网络错误，请稍后重试！');
							plus.nativeUI.closeWaiting();
						}
					}
				});
			}
			
			function renderInit(result) {
				if (result.status == -1) {
					document.getElementById('phone').value = result.data.tel;
					document.getElementById('bgl').src = PREVIOUS_REQUEST_DOMAIN + result.data.erweima;
//					var src = result.data.erweima.replace('../../', PREVIOUS_REQUEST_DOMAIN);
//					document.getElementById('bgl').src = src;
				} else {
					plus.nativeUI.toast(result.message);
				}
			}
			
			mui.plusReady(function() {
				initLoad();
				
				mui(document).on('tap', '#liFirst', function() {
					mui.openWindow({
						url: '../myzone/managearticle.html',
						id: 'myZoneManagedArticle'
					});
				});
				
				mui(document).on('tap', '#liSecond', function() {
					mui.openWindow({
						url: '../myzone/aboutme.html',
						id: 'myZoneAboutMe'
					});
				});
				
				mui(document).on('tap', '#aFirst', function() {
					mui.openWindow({
						url: '../myzone/managearticle.html',
						id: 'myZoneManageArticle'
					});
				});
				
				mui(document).on('tap', '#aSave', function() {
					var phone = document.getElementById('phone').value;
					var erweima = document.getElementById('erweima').value;
					console.log('local: ' + erweima);
					mui.ajax(REQUEST_DOMAIN + 'center/personalCenter.php/contactEdit', {
						data: {
							token: localStorage.getItem(TOKEN),
							phone: phone,
							erweima: ''+erweima
						},
						dataType:'json',
						type:'POST',
						timeout:10000,
						success: function(result) {
							console.log(JSON.stringify(result));
							if (result.status == -1) {
								plus.nativeUI.toast('修改成功');
								plus.webview.currentWebview().reload();
							} else {
								plus.nativeUI.toast('修改失败');
							}
						},
						error: function(xhr,type,errorThrown) {
							if (type == 'timeout') {//超时
								plus.nativeUI.toast('服务器超时，请稍后重试！');
							} else {
								plus.nativeUI.toast('网络错误，请稍后重试！');
							}
						}
					});
				});
			});
		</script>
	</body>
</html>
