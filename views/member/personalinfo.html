<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/style.css" rel="stylesheet" type="text/css" />
		<link href="../../css/tx/css/style.css" rel="stylesheet" type="text/css">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/feng.css" rel="stylesheet" type="text/css" />
		<style type="text/css">
		    .gg_top{width:100%; height:50px; line-height:50px; text-align:center; position:relative; background:#ececee; border-bottom:1px solid #e5e5e5;}
		    .gg_top p{ color:#ff4e00; font-size:1.2rem;}
		    .gg_top .gg_right{ position:absolute; bottom:3px; right:10px;}
		    .gg_top .gg_right a{ color:#ff4e00;}
		    .gg_top .gg_left{position:absolute; bottom:3px; left:10px;border-bottom:0px;}
		    .gg_top .gg_left img{ float:left; margin-top:16px; margin-right:1px; width:10px;}
		    .gg_top .gg_left a{color:#ff4e00;}
	    </style>
		<script src="../../js/mui.min.js"></script>
	</head>
	<body id="pullrefresh">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-pull-left main-color"><</a>
		    <h1 class="mui-title main-color">个人信息</h1>
		</header>
		<div class="mui-content">
			<div class="grxx_con">
		        <div class="grxx_top" id="uploadImage">
		            <img src="../../css/tx/images/touxiang.png" style="width:70px;height:70px;border-radius:50px;margin-left:20px;" id="touxiang" />
		            <p>修改头像<img src="../../img/gr_2.gif"/></p>
		        </div>
	            <div class="top_tip">
	                <p style="width: 100%; text-align: center;color: red;">请完善个人信息</p>
	            </div>
		        <div class="grxx_list">
		            <p class="glist_left">昵称</p>
		            <input class="glist_right" id='realname' type="text" value="" name="realname" placeholder="这家伙很懒什么都没留下！" />
		        </div>
		        <div class="grxx_list">
		            <p class="glist_left">手机号</p>
		            <input class="glist_right" id="tel" type="text" value="" name="phone" placeholder="这家伙很懒什么都没留下！" />
		        </div>
		        <div class="grxx_list">
		            <p class="glist_left">个性签名</p>
		            <input class="glist_right" id="qianming" type="text" value="" name="qianming" placeholder="这家伙很懒什么都没留下！" />
		        </div>
		        <div class="grxx_list">
		            <p class="glist_left">公司名称</p>
		            <input class="glist_right" id="company" type="text" value="" name="company" placeholder="这家伙很懒什么都没留下！" />
		        </div>
		        <div class="grxx_list">
		            <p class="glist_left">个人简介</p>
		            <textarea class="glist_right glist_righta" id="jieshao" name="jieshao" value="" cols="45" rows="5" placeholder="这家伙很懒什么都没留下！"></textarea>
		        </div>
		        <div class="grxx_wx">
		            <div class="grxx_left">
		                <p>微信二维码</p>
		                <div class="erweima">
		                    <div class="weiera" id="logoBox">
		                    	<img src="../../img/gr_1.gif" id="bgl" style="width:100%;height: 100%;margin: 0px;"/>
		                    </div>
		                    <input type="hidden" name="erweima" id="erweima" value="">
		                    <input type="hidden" name="touxiang" id="touxiang" value="">
		                </div>
		            </div>
		        </div>
		    </div>
		    <div class="wz_foot grxx">
			    <ul>
			        <li class="wz_fleft"><a href="javascript:void(0);" id="cancel">取消</a></li>
			        <li class="wz_fright"><a href="javascript:void(0);" id="subInfo">保存</a></li>
			    </ul>
			</div>
			
			<div class="htmleaf-container">
			    <div id="clipArea"></div>
			    <div id="view"></div>
			</div>
			<div id="dpage">
			    <a href="javascript:void(0);">
			        <input type="button" name="quxiao" id="quxiao" class="button" value="取消">
			    </a>
			    <a href="javascript:void(0);">
			        <input type="button" name="file" class="button" value="选取照片">
			        <input id="file" type="file" onchange="javascript:setImagePreview();" accept="image/*"/>
			    </a>
			    <a href="javascript:void(0);" class="qx"><button id="clipBtn">截取图片</button></a>
			</div>
			
			<div class="thtmleaf-container">
			    <div id="tclipArea"></div>
			    <div id="tview"></div>
			</div>
			<div id="tpage">
			    <a href="javascript:void(0);">
			        <input type="button" name="tquxiao" id="tquxiao" class="button" value="取消">
			    </a>
			    <a href="javascript:void(0);">
			        <input type="button" name="file" class="button" value="选取照片">
			        <input id="tfile" type="file" onchange="javascript:setImagePreview();" accept="image/*"/>
			    </a>
			    <a href="javascript:void(0);" class="qx"><button id="tclipBtn">截取图片</button></a>
			</div>
		</div>
		<script src="../../css/tx/js/jquery.min.js" type="text/javascript"></script>
		<script>window.jQuery || document.write('<script src="../../css/tx/js/jquery-2.1.1.min.js"><\/script>')</script>
		<script src="../../css/tx/js/iscroll-zoom.js"></script>
		<script src="../../css/tx/js/hammer.js"></script>
		<script src="../../css/tx/js/jquery.photoClip.js?123"></script>
		<script src="../../js/constant.js"></script>
		<script type="text/javascript">
			mui.init({				
				pullRefresh: {  
                	container: '#pullrefresh',  
                  	down: { 
                  		style:'circle',//必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
					    color:'#ff6c00', //可选，默认“#2BD009” 下拉刷新控件颜色
					    height:'50px',//可选,默认50px.下拉刷新控件的高度,
					    range:'100px', //可选 默认100px,控件可下拉拖拽的范围
					    offset:'0px', //可选 默认0px,下拉刷新控件的起始位置
					    auto: true,//可选,默认false.首次加载自动上拉刷新一次
                      	callback: pulldownRefresh  
                  	},
              	}  
			})
			
			function pulldownRefresh() {  
              setTimeout(function () {  
                  ajaxLoadUserInfo(); 
                  mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed  
              }, 1500);  
          	} 
          	
          	
          	//获取会员服务用户信息
			function ajaxLoadUserInfo() {
				mui.ajax(REQUEST_DOMAIN + 'services/memberServices.php', {
					data: {
						action:'personalData',
						token: localStorage.getItem(TOKEN)
					},
					dataType:'json',
					type:'POST',
					timeout:5000,
					success: renderUserInfo,
					error: function(xhr,type,errorThrown) {
						if (type == 'timeout') {//超时
							plus.nativeUI.toast('服务器超时，请稍后重试！');
						} else {
							plus.nativeUI.toast('网络错误，请稍后重试！');
						}
					}
				});
			}
			
			function renderUserInfo(result) {
//				console.log(JSON.stringify(result));
				if (result.status == -1) {
					document.getElementById('touxiang').src = PREVIOUS_REQUEST_DOMAIN+result.data.img;
					if(result.data.realname != 0){
						document.getElementById('realname').value = result.data.realname;
					}
					if(result.data.tel != 0){
						document.getElementById('tel').value = result.data.tel;
					}
					if(result.data.qianming != 0){
						document.getElementById('qianming').value = result.data.qianming;
					}
					if(result.data.company != 0){
						document.getElementById('company').value = result.data.company;
					}
					if(result.data.jieshao){
						document.getElementById('jieshao').value = result.data.jieshao;
					}
					if(result.data.erweima != 0){
						document.getElementById('bgl').src = PREVIOUS_REQUEST_DOMAIN+result.data.erweima;
					}
				} else {
					plus.nativeUI.toast(result.message);
				}
			}
			
			//调用修改数据接口
			function ajaxUser(realname, phone, qianming,company,jieshao,touxiang,erweima) {
				mui.ajax(REQUEST_DOMAIN + 'services/memberServices.php', {
					type: 'POST',
					data: {
						action:'personalEdit',
						token: localStorage.getItem(TOKEN),
						realname:realname,
						phone:phone,
						qianming:qianming,
						company:company,
						jieshao:jieshao,
						touxiang:touxiang,
						erweima:erweima
					},
					success: function(result) {
//						console.log(JSON.stringify(result));
						if (result.status == -1) {
							plus.nativeUI.toast('保存成功');
							mui.openWindow({
								url:'index.html',
								createNew: true,
								show:{
									autoShow: true,
									aniShow: ''
								},
								waiting: {
									autoShow: false
								}
							});
						} else {
							plus.nativeUI.toast(result.message);
						}
					}
				});
			}
			
          	mui.plusReady(function() {
				ajaxLoadUserInfo();
				//提交数据
				document.getElementById('subInfo').addEventListener('tap', function() {
					var realname = document.getElementById('realname').value;
					var phone = document.getElementById('tel').value;
					var qianming = document.getElementById("qianming").value;
					var company = document.getElementById('company').value;
					var jieshao = document.getElementById('jieshao').value;
					var touxiang = document.getElementById('touxiang').value;
					var erweima = document.getElementById('erweima').value;
					if (phone != '') {
						if (!phone.match(/^(((1[3|4|5|7|8][0-9]{1}))+\d{8})$/)) {
							plus.nativeUI.toast('手机号格式错误');
						}else{
							ajaxUser(realname, phone, qianming,company,jieshao,touxiang,erweima);
						}
					}else{
						ajaxUser(realname, phone, qianming,company,jieshao,touxiang,erweima);
					}
						
				});
				
				//取消修改个人信息
				mui(document).on('tap', '#cancel', function() {
					mui.openWindow({
						url: 'index.html',
						createNew: true,
						show:{
							autoShow: true,
							aniShow: ''
						},
						waiting: {
							autoShow: false
						}
					});
				});
			});
          	
			var obUrl = ''
		    $("#clipArea").photoClip({
		        width: 280,
		        height: 280,
		        file: "#file",
		        view: "#view",
		        ok: "#clipBtn",
		        loadStart: function() {
		            console.log("照片读取中");
		        },
		        loadComplete: function() {
		            console.log("照片读取完成");
		        },
		        clipFinish: function(dataURL) {
		            console.log(dataURL);
		        }
		    });
		    $("#tclipArea").photoClip({
		        width: 280,
		        height: 280,
		        file: "#tfile",
		        view: "#tview",
		        ok: "#tclipBtn",
		        loadStart: function() {
		            console.log("照片读取中");
		        },
		        loadComplete: function() {
		            console.log("照片读取完成");
		        },
		        clipFinish: function(dataURL) {
		            console.log(dataURL);
		        }
		    });
		    
		    function setImagePreview() {
		        var preview, img_txt, localImag, file_head = document.getElementById("file_head"),
		            picture = file_head.value;
		        if (!picture.match(/.jpg|.gif|.png|.jpeg|.bmp/i)) return alert("您上传的图片格式不正确，请重新选择！"),
		            !1;
		        if (preview = document.getElementById("preview"), file_head.files && file_head.files[0]) preview.style.display = "block",
		            preview.style.width = "100px",
		            preview.style.height = "100px",
		            preview.src = window.navigator.userAgent.indexOf("Chrome") >= 1 || window.navigator.userAgent.indexOf("Safari") >= 1 ? window.webkitURL.createObjectURL(file_head.files[0]) : window.URL.createObjectURL(file_head.files[0]);
		        else {
		            file_head.select(),
		                file_head.blur(),
		                img_txt = document.selection.createRange().text,
		                localImag = document.getElementById("localImag"),
		                localImag.style.width = "100px",
		                localImag.style.height = "100px";
		            try {
		                localImag.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)",
		                    localImag.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = img_txt
		            } catch(f) {
		                return alert("您上传的图片格式不正确，请重新选择！"),
		                    !1
		            }
		            preview.style.display = "none",
		                document.selection.empty()
		        }
		        return document.getElementById("DivUp").style.display = "block",
		            !0
		    }
		</script>
		<script>
		    $(function(){
		        $("#logoBox").click(function(){
		            $(".htmleaf-container").fadeIn(300);
		            $("#dpage").addClass("show");
		        });
		        $("#quxiao").click(function(){
		            $(".htmleaf-container").hide();
		            $("#dpage").removeClass("show");
		        });
		        $("#clipBtn").click(function(){
		            $("#logoBox").empty();
		            $('#logoBox').append('<img src="' + imgsource + '" align="absmiddle" style=" width:100%;margin-top:0;">');
		            $('#erweima').val(imgsource);
		            $(".htmleaf-container").hide();
		            $("#dpage").removeClass("show");
		        });
		        $("#uploadImage").click(function(){
		            $(".thtmleaf-container").fadeIn(300);
		            $("#tpage").addClass("show");
		        });
		        $("#tquxiao").click(function(){
		            $(".thtmleaf-container").hide();
		            $("#tpage").removeClass("show");
		        });
		        $("#tclipBtn").click(function(){
		            $("#uploadImage").empty();
		            $('#uploadImage').append('<img src="' + imgsource + '" align="absmiddle" style="width:70px;height:70px;border-radius:50px;">');
		            $('#touxiang').val(imgsource);
		            $(".thtmleaf-container").hide();
		            $("#tpage").removeClass("show");
		        });
		    });
		</script>
	</body>
</html>
